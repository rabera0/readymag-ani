import{A as y,D as pe,a as g,b,c as F,d as se,p as Ae,r as ne,s as Oe,t as S,u as A,w as O,y as ae,z as _e}from"https://st-p.rmcdn.net/a09f30ec/dist/c/c-YA3VO7L3.js";import{a as re,b as Te}from"https://st-p.rmcdn.net/a09f30ec/dist/c/c-7RV7N453.js";import{b as Q,c as Me}from"https://st-p.rmcdn.net/a09f30ec/dist/c/c-CQ3QLQK5.js";import{m as B,o as ee,t as Re}from"https://st-p.rmcdn.net/a09f30ec/dist/c/c-YM5H3BT6.js";import{a as de,b as De}from"https://st-p.rmcdn.net/a09f30ec/dist/c/c-3GGLYD6B.js";import{a as v,b as oe}from"https://st-p.rmcdn.net/a09f30ec/dist/c/c-FWO3KNVK.js";import{c as T,l as te,p as ie}from"https://st-p.rmcdn.net/a09f30ec/dist/c/c-WSWR4Q44.js";import{a as J}from"https://st-p.rmcdn.net/a09f30ec/dist/c/c-7ZY2VSVL.js";import{A as G,h as Y,i as $,z as V}from"https://st-p.rmcdn.net/a09f30ec/dist/c/c-5JZ2YWXB.js";import{e as C,j as M,k as f,l as R}from"https://st-p.rmcdn.net/a09f30ec/dist/c/c-KI5HOILD.js";import{b as X}from"https://st-p.rmcdn.net/a09f30ec/dist/c/c-IJGABWID.js";import{a as L,c as Ve,d as w,e as K}from"https://st-p.rmcdn.net/a09f30ec/dist/c/c-SLUQJE2K.js";import{a as m,d as q,f as n}from"https://st-p.rmcdn.net/a09f30ec/dist/c/c-4X7D5KOI.js";var ce=m(()=>{"use strict"});var ge,le=m(()=>{"use strict";ce();ge=(l=21)=>crypto.getRandomValues(new Uint8Array(l)).reduce((c,e)=>(e&=63,e<36?c+=e.toString(36):e<62?c+=(e-26).toString(36).toUpperCase():e>62?c+="-":c+="_",c),"")});var x,z=m(()=>{"use strict";le();b();ie();x=class extends g{constructor(){super();n(this,"triggersState",{});n(this,"triggersElements",{});this.initStore()}bindTriggerElement(e,t){this.setState(i=>({triggersElements:{...i.triggersElements,[e]:t}})),this.bindTriggerCallback(e)}bindTriggerCallback(e){let t=this.triggersState[e]||{},i=this.triggersElements[e];if(!i)return;let r=[];for(let o in t){let a=t[o];a&&(typeof a.unbind=="function"&&a.unbind(),a.unbind=te({element:i,events:a.events,callback:a.callback}),r.push(a.unbind))}return r}addTriggerCallback({responderWidgetId:e,triggerWidgetIds:t=[],events:i,callback:r}){let o=ge(),a=[];for(let p of t){let s=`${e}-${o}`;p in this.triggersState||this.setState(d=>({triggersState:{...d.triggersState,[p]:{}}})),this.setState(d=>({triggersState:{...d.triggersState,[p]:{...d.triggersState[p],[s]:{events:i,callback:r}}}}));let u=this.bindTriggerCallback(p)||[];a.push(()=>{for(let d of u)typeof d=="function"&&d();delete this.triggersState[p][s]})}return()=>{for(let p of a)p()}}isWidgetTrigger(e){return e in this.triggersState}}});var j,U=m(()=>{"use strict";G();b();Ae();Te();j=class extends g{constructor(){super();n(this,"animations",{});n(this,"groupRects",{});n(this,"groupState",{});this.initStore()}getAnimationsGroups(e){let t={},i=Y(Object.values(e).map(o=>o.animations).flat(),"UUID"),r=Object.entries(e);for(let[o,a]of r)for(let p of a.animations)i[p.UUID]>1&&(t[p.UUID]=[...t[p.UUID]||[],{widgetId:o,rect:a.rect}]);return t}getAnimationsGroupsRects(e){let t={},i=Object.keys(e);for(let r of i){let o=e[r].map(h=>{let Ie=this.animations[h.widgetId].transforms.rotation?.angle??0;return re.rotateBox(h.rect,Ie)}),a=Math.min(...o.map(h=>h.top)),p=Math.min(...o.map(h=>h.left)),s=Math.max(...o.map(h=>h.top+h.height)),d=Math.max(...o.map(h=>h.left+h.width))-p,P=s-a;t[r]={top:a,left:p,width:d,height:P}}return t}createGroupsState(e,t){let i={...e};for(let r in t){i[r]=i[r]||{};for(let o of t[r])o.widgetId in i[r]||(i[r][o.widgetId]=!1)}return i}addWidget({widgetId:e,animations:t,rect:i,rotation:r,flipY:o,flipX:a}){this.setState(p=>({animations:{...p.animations,[e]:{rect:i,animations:t,transforms:{flipX:a,flipY:o,rotation:F(r),invertedRotation:F((r||0)*-1)}}}})),this.recalculateRectsStates()}recalculateRectsStates(){let e=this.getAnimationsGroups(this.animations),t=this.getAnimationsGroupsRects(e),i=this.createGroupsState(this.groupState,e);this.setState({groupRects:t,groupState:i})}updateWidgetRect(e,t){this.setState(i=>({animations:{...i.animations,[e]:{...i.animations[e],rect:t}}})),this.recalculateRectsStates()}getAnimationsGroupRect(e){return e in this.groupRects?this.groupRects[e]:null}getAnimationsGroupOrigin(e,t){if(e in this.groupRects&&t in this.animations){let i=this.animations[t],r=i.transforms,o=i.rect,a=this.groupRects[e],p={x:o.left-a.left,y:o.top-a.top},s={x:a.width/2,y:a.height/2},u={x:s.x-p.x,y:s.y-p.y},d=se({rotation:r.invertedRotation,point:u,origin:{...o,left:0,top:0}});return r.flipX&&(d.x=o.width-d.x),r.flipY&&(d.y=o.height-d.y),d}return null}getGroupState(e){return e in this.groupState?Object.values(this.groupState[e]).some(Boolean):null}updateGroupState(e,t,i,r=!1){if(e in this.groupState)if(e in this.groupState||this.setState(o=>({groupState:{...o.groupState,[e]:{}}})),r)for(let o in this.groupState[e])this.setState(a=>({groupState:{...a.groupState,[e]:{[o]:i}}}));else this.setState(o=>({groupState:{...o.groupState,[e]:{[t]:i}}}))}getAnimationsWidgetRect(e){return this.animations[e]?.rect||null}}});var W,Z=m(()=>{"use strict";b();W=class extends g{constructor(){super();n(this,"zIndexes",{});this.initStore()}init(e){for(let t of e)typeof t.model.z=="number"&&this.setZIndex(t.model._id,t.model.z)}getTopmostZIndex(){return Math.max(...Object.values(this.zIndexes))}setZIndex(e,t){typeof t=="number"&&this.zIndexes[e]!==t&&this.setState(i=>({zIndexes:{...i.zIndexes,[e]:t}}))}}});var He,_,ue=m(()=>{"use strict";b();R();K();O();O();He={pageId:"",scale:1,zoom:1,transform:1,num:0,availableViewports:[],currentViewport:"default",hasTabletViewport:!1,hasPhoneViewport:!1,screenshot:"",desktopPageHeight:0,tabletPageHeight:0,phonePageHeight:0,widgetsIds:[]},_=class extends g{constructor(e){super();n(this,"projectViewport");n(this,"page");n(this,"state",He);this.initStore(),this.page=e.page,this.setState({projectViewport:e.projectViewport.value}),e.projectViewport.subscribe(t=>t.value,t=>{this.setState({projectViewport:t}),this.computePageMeta()}),this.page.subscribe(t=>t.model,()=>{this.computePageMeta()}),this.computePageMeta()}computePageMeta(){let e=this.doesPageHasViewport("tablet_portrait"),t=this.doesPageHasViewport("phone_portrait"),i=["default",e&&"tablet_portrait",t&&"phone_portrait"].filter(Boolean);this.setState(r=>({state:{...r.state,pageId:this.page.model._id,num:this.page.model.num,uri:this.page.model.uri,seo:this.page.model.seo,customSeo:this.page.model.custom_shares,screenshot:this.page.model.screenshot,desktopPageHeight:A(this.page.model,"default"),tabletPageHeight:A(this.page.model,"tablet_portrait"),phonePageHeight:A(this.page.model,"phone_portrait"),currentViewport:this.getPageViewport(this.projectViewport),hasTabletViewport:e,hasPhoneViewport:t,availableViewports:i,widgetsIds:this.page.model.widgets?.map(o=>o._id)??[]}}))}onScaleChange(e){this.setState(t=>({state:{...t.state,scale:e,zoom:w.isFirefox()?1:e,transform:w.isFirefox()?e:1}}))}getClosestViewport(e){let t=f.dictionary[e].width,i=f.viewports.reduce((r,o,a)=>{let p=S(o.name);if(p!=="viewport_default"){let s=this.page.model[p];if(!s||!s.enabled)return r}return Math.abs(o.width-t)<=Math.abs(f.viewports[r].width-t)?a:r},0);return f.viewports[i].name}doesPageHasViewport(e){let t=S(e);return t==="viewport_default"?!this.page.model.hidden:t in this.page.model&&!!this.page.model[t]?.enabled}getPageViewport(e){return!e||e==="default"||this.doesPageHasViewport(e)?e:this.getClosestViewport(e)}}});function Le(l){return ee(l)?l.code.length>0:!0}function me(l,c){let e=v(l);return M(e,(t,i)=>{t&&i!==c&&(t.hidden=!0)}),e}var I,Rt,Tt,N=m(()=>{"use strict";R();z();U();Z();G();oe();b();pe();ue();Oe();Re();ie();O();I=class extends g{constructor(e){super();n(this,"project");n(this,"triggersStore");n(this,"animationsStore");n(this,"zIndexStore");n(this,"model");n(this,"meta");n(this,"element");n(this,"widgets");this.initStore(),this.project=e.project,this.setState({triggersStore:new x,animationsStore:new j,zIndexStore:new W,element:new ne,model:e.page}),this.setState({meta:new _({page:this,projectViewport:e.project.projectViewport})}),this.setState({widgets:this.createWidgets(this.model.widgets)}),this.zIndexStore.init(Object.values(this.widgets).flat())}createWidgets(e=[]){let t={topFixed:[],backFixed:[],regular:[]};if(!e.length)return t;let i=s=>({...s,pid:this.model._id}),r=v(this.project.model.globalWidgets||[]).map(i),o=v(e).map(i),a=V([...o,...r],s=>s._id),p=this.getWidgetsRenderList(a);p.background&&(t.background=this.createWidget(p.background));for(let s of p.topFixed)t.topFixed.push(this.createWidget(s));for(let s of p.backFixed)t.backFixed.push(this.createWidget(s));for(let s of p.regular)t.regular.push(this.createWidget(s));return t}createWidget(e){return new y({pageMeta:this.meta,project:this.project,triggersStore:this.triggersStore,animationsStore:this.animationsStore,zIndexStore:this.zIndexStore,widget:e})}setWidgets(e){this.setState(t=>({model:{...t.model,widgets:e},widgets:this.createWidgets(e)})),this.zIndexStore.init(Object.values(this.widgets).flat())}getWidgetsRenderList(e=[]){if(!e||!e.length)return{regular:[],topFixed:[],backFixed:[]};let t,i=[],r=[],o=[],a=C.reduce((s,u)=>(s[u]=1/0,s),{}),p=C.filter(s=>this.isViewportEnabled(s));for(let s of e)if(Le(s))if(B(s))t=s;else{if(s.is_above)continue;for(let u of p){let d=y.getWidgetViewportData(s,u,this.model._id);d&&(d.fixed_position||(i.push(s),a[u]=Math.min(a[u],d.z)))}}for(let s of p)a[s]===1/0&&(a[s]=0);for(let s of e)if(!(B(s)||s.is_above))for(let u of p){let d=y.getWidgetViewportData(s,u,this.model._id);!d||!d.fixed_position||(d.z<a[u]?r.some(P=>P._id===s._id)?o.push(me(s,u)):o.push(s):o.some(P=>P._id===s._id)?r.push(me(s,u)):r.push(s))}return i=V(i,s=>s._id),o=V(o,s=>s._id),r=V(r,s=>s._id),{background:t,regular:T(i),topFixed:T(r),backFixed:T(o)}}isViewportEnabled(e){let t=S(e);return t==="viewport_default"?!0:this.model[t]?.enabled}},{useStore:Rt,Provider:Tt}=g.createContext()});var D,he=m(()=>{"use strict";R();G();b();Ve();K();D=class extends g{constructor(){super();n(this,"value","default");this.initStore(),this.setState({value:this.getProjectViewport()}),this.bindEvents()}bindEvents(){if(L())return;let e=$(this.refreshProjectViewport,40);window.addEventListener("resize",e),window.addEventListener("orientationchange",e)}refreshProjectViewport(){this.setState({value:this.getProjectViewport()})}getProjectViewport(){if(L())return"default";let e=window.innerWidth,t=w.isPortrait();if(w.isIpad())return t?"tablet_portrait":"default";if(window.devicePixelRatio>1||w.isMobile()||w.isTouch()){if(t)return e<=599?"phone_portrait":e>=600&&e<=1024?"tablet_portrait":"default";if(e>980)return"default";let i=f.viewports.reduce((r,o,a)=>Math.abs(o.width-e)<=Math.abs(f.viewports[r].width-e)?a:r,0);return f.viewports[i].name}return"default"}}});var Ce,E,fe=m(()=>{"use strict";X();b();O();Ce={viewertype:"vertical"},E=class extends g{constructor(e){super();n(this,"projectViewport");n(this,"_state");n(this,"state");this.initStore(),this.setState({projectViewport:e.project.projectViewport.value}),e.project.projectViewport.subscribe(t=>t.value,t=>{this.setState({projectViewport:t}),this.computeOptions()}),this._state={options:{...Ce,...e.project.model.opts||{}},viewport_phone_portrait:{options:e.project.model.viewport_phone_portrait?.opts||{}},viewport_tablet_portrait:{options:e.project.model.viewport_phone_portrait?.opts||{}}},this.setState({state:this._state.options}),this.computeOptions()}getOverrides(e){return e!=="viewport_default"?this._state[e]?.options:{}}computeOptions(){this.setState({state:this.getOptionsForViewport(this.projectViewport)})}setOptions(e){let t=S(this.projectViewport);if(t==="viewport_default"){let i={...this._state.options,...e};this._state.options=i}else{let r={...this.getOverrides(t),...e},o={...this._state.options,...r};this._state[t].options=o}this.computeOptions(),window.dispatchEvent(new Event("resize"))}getOptionsForViewport(e){let t=S(e),i=this.getOverrides(t);return{...this._state.options,...i}}}});function Pe(l){let c=null;function e(r){return c||(c=new de(l),Q("scroll",c)),c?.addListener(r),()=>{c?.removeListener(r)}}function t(r,o=[]){(0,be.useEffect)(()=>{let a=e(r);return()=>{a()}},o)}function i(){c?.destroy()}return{useScrollPosition:t,destroyScroll:i,scrollSubscribe:e}}var be,we=m(()=>{"use strict";be=q(J());De();Me()});var Jt,Qt,Se,ve=m(()=>{"use strict";we();({useScrollPosition:Jt,destroyScroll:Qt,scrollSubscribe:Se}=Pe())});var ye,k,xe=m(()=>{"use strict";ye=q(J());X();R();pe();_e();ve();k=class extends y{constructor(e){super(e);n(this,"viewertype");n(this,"project");n(this,"currentPageId");n(this,"nextAdjacentPageId");n(this,"nextPageData",null);this.currentPageId=e.initialPageId,this.project=e.project,this.viewertype=this.project.options.state.viewertype,this.project.options.subscribe(t=>t.state.viewertype,t=>{this.viewertype=t}),this.setCurrentPage(e.initialPageId),this.bindScrollListener()}setCurrentPage(e){(0,ye.startTransition)(()=>{this._model.pid!==e&&(M(this._model,t=>{t&&(t.pid=e,Object.assign(t,ae(t,e)))}),this.computeWidgetModel())})}bindRouter(e){e.subscribe(t=>({currentPageId:t.state.currentPageId,nextAdjacentPageId:t.state.nextAdjacentPageId}),()=>{this.setCurrentPage(e.state.currentPageId),this.currentPageId=e.state.currentPageId,this.nextAdjacentPageId=e.state.nextAdjacentPageId;let t=this.nextAdjacentPageId?this.project.findPageById(this.nextAdjacentPageId):void 0;t&&(this.nextPageData={pageScale:t.meta.state.scale,offsetTop:t.element.offset.top})},!0)}bindScrollListener(){this.viewertype==="vertical"&&Se(this.handleAboveWidgetsScroll)}handleAboveWidgetsScroll(e){if(!this.nextPageData){this.handleVisibility(!1,!1);return}let t=this.element.rect.height,i=this.element.offset.top,r=this.nextPageData.pageScale,o=t*r,a=i*r,p=this.nextPageData.offsetTop,s=e.scrollTop,u=p-s<a+o,d=p-s<a,P=!this.handleVisibility(u,d);P!==this.visibility.isVisible&&this.setState({visibility:{...this.visibility,isVisible:P}})}handleVisibility(e,t){return this.nextAdjacentPageId?(this.isAboveWidgetHidden(this.currentPageId)||e&&this.isAboveWidgetHidden(this.nextAdjacentPageId))&&!(t&&!this.isAboveWidgetHidden(this.nextAdjacentPageId)):this.isAboveWidgetHidden(this.currentPageId)}isAboveWidgetHidden(e){let t=this.model.hidden,i=this.model._hidden;if(i&&Array.isArray(i)){let r=i.find(o=>o.pid===e)||i.find(o=>o.pid==="default");if(r&&typeof r.value=="boolean")return r.value}return!!t}}});var H,je=m(()=>{"use strict";N();z();U();Z();xe();b();H=class extends g{constructor(e){super();n(this,"project");n(this,"triggersStore");n(this,"animationsStore");n(this,"zIndexStore");n(this,"aboveWidgets");n(this,"abovePage");this.initStore(),this.project=e.project,this.setState({triggersStore:new x,animationsStore:new j,zIndexStore:new W}),this.setState({abovePage:new I({page:{_id:"above-page",num:-1,num_id:-1,height:0},project:this.project}),aboveWidgets:this.createAboveAllWidgets(e.aboveAllWidgets,e.initialPageId)}),this.zIndexStore.init(this.aboveWidgets)}createAboveAllWidgets(e=[],t){let i=[];for(let r of e)i.push(new k({widget:r,initialPageId:t,pageMeta:void 0,project:this.project,triggersStore:this.triggersStore,animationsStore:this.animationsStore,zIndexStore:this.zIndexStore}));return i}bindAboveWidgetsRouter(e){for(let t of this.aboveWidgets)t.bindRouter(e)}}});var We,xi,ji,Be=m(()=>{"use strict";oe();b();N();he();fe();je();We=class extends g{constructor(e){super();n(this,"model");n(this,"pages",[]);n(this,"projectViewport");n(this,"options");n(this,"meta");n(this,"abovePage");this.initStore(),this.setState({model:e.project,projectViewport:new D}),this.setState({options:new E({project:this})}),this.setState({meta:{num_id:this.model.num_id,title:this.model.title||"",description:this.model.title||"",masterSharePageId:this.model.master_share_pid||"",editParams:this.model.edit_params||{},owner:this.model.user,forbiddenBackground:this.model.pass_bg,publicPath:e.publicPath,isExportedProject:e.isExportedProject||!1,isProjectOnDomain:e.isProjectOnDomain||!1,isProjectOnProfileDomain:e.isProjectOnProfileDomain||!1,exportedBasePath:e.exportedBasePath||""},pages:this.createPages(this.model.pages||[]),abovePage:new H({aboveAllWidgets:this.model.aboveAllWidgets,initialPageId:e.initialPageId||this.findPageByIndex("first")?.model._id||"",project:this})})}createPages(e){let t=[];for(let i of e)t.push(new I({project:this,page:v(i)}));return t}findPageByIndex(e){let t=typeof e=="number"?e:e==="first"?0:this.pages.length-1,i=this.pages[t];if(i)return i}findPageById(e){return this.pages.find(t=>t.model._id===e)}findPageByUri(e){return this.pages.find(t=>t.model.uri===e)}findPageByNum(e){return this.pages.find(t=>t.model.num===e)}getPageIndex(e){let t=this.pages.findIndex(i=>i.model._id===e);return t===-1?null:t}getPageUri(e){let t=this.findPageById(e);return t?t.model.uri?`${t.model.uri}/`:t.model.num===1?"":`${t.model.num}/`:null}getPageNum(e){let t=this.findPageById(e);return t?t.model.num:null}getFirstPage(){return this.pages[0]}getLastPage(){return this.pages[this.pages.length-1]}},{useStore:xi,Provider:ji}=g.createContext()});export{Rt as a,Tt as b,N as c,Jt as d,ve as e,We as f,xi as g,ji as h,Be as i};
